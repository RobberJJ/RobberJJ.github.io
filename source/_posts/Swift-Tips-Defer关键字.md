---
title: Swift Tips - Deferå…³é”®å­—
date: 2018-12-04 10:47:44
tags:
	- Swift
	- iOS
	- Swift Tips
categories: "swift"
---

å‰é¢æœ‰è¯´åˆ°ï¼Œåœ¨ *swift 2.0*  å¼•å…¥äº† `guard` å…³é”®å­—ï¼Œå¯ä»¥è®©ä»£ç ç¼–å†™æ›´æµç•…ã€‚å®ƒçš„ä¼˜é›…ç®€æ´è€ŒåŠŸèƒ½å¼ºå¤§ç¡®å®ç»™äº†æˆ‘ä»¬æå¤§çš„æ–¹ä¾¿ã€‚å…·ä½“å¯ä»¥å‚è§ [è¿™é‡Œ](https://robberjj.github.io/2018/11/30/Swift-Tips-if-let-var-guard-let-var-%E5%85%A8%E8%A7%A3%E6%9E%90/) ã€‚

è€Œï¼Œè·Ÿ `guard` ä¸€åŒå¼•å…¥çš„è¿˜æœ‰ä¸€ä¸ªå…³é”®å­— â€”â€” `defer` ã€‚

#### defer

ä¸€å¥è¯æ€»ç»“ `defer` å°±æ˜¯ï¼šè®©æ‰§è¡Œæ¨è¿Ÿã€‚



<!-- more -->



æˆ‘ä»¬çŸ¥é“ï¼Œåœ¨é”™è¯¯å¤„ç†æ–¹é¢ï¼Œ`guard`Â å’Œæ–°çš„Â `throw`Â è¯­æ³•ä¹‹é—´ï¼ŒSwift é¼“åŠ±ç”¨å°½æ—©è¿”å›é”™è¯¯ï¼ˆè¿™ä¹Ÿæ˜¯æˆ‘æœ€å–œæ¬¢çš„æ–¹å¼ï¼‰æ¥ä»£æ›¿åµŒå¥— if çš„å¤„ç†æ–¹å¼ã€‚å°½æ—©è¿”å›è®©å¤„ç†æ›´æ¸…æ™°äº†ï¼Œä½†æ˜¯å·²ç»è¢«åˆå§‹åŒ–ï¼ˆå¯èƒ½ä¹Ÿæ­£åœ¨è¢«ä½¿ç”¨ï¼‰çš„èµ„æºå¿…é¡»åœ¨è¿”å›å‰è¢«å¤„ç†å¹²å‡€ã€‚

`defer`Â å…³é”®å­—ä¸ºæ­¤æä¾›äº†å®‰å…¨åˆç®€å•çš„å¤„ç†æ–¹å¼ï¼šå£°æ˜ä¸€ä¸ª `block`ï¼Œå½“å‰ä»£ç æ‰§è¡Œçš„é—­åŒ…é€€å‡ºæ—¶ä¼šæ‰§è¡Œè¯¥ `block` ã€‚

å…·ä½“æˆ‘ä»¬æ¥çœ‹ä¸‹é¢è¿™ä¸ªæ —å­ï¼š

#### ä¸¾ä¸ªæ —å­

```swift
import Darwin

func currentHostName() -> String {
    let capacity = Int(NI_MAXHOST)
    let buffer = UnsafeMutablePointer<Int8>.allocate(capacity: capacity)

    //è°ƒç”¨ gethostname(2) çš„å‡½æ•°ï¼Œç”¨æ¥è¿”å›å½“å‰ç³»ç»Ÿçš„ä¸»æœºåç§°
    guard gethostname(buffer, capacity) == 0 else {
        buffer.deallocate()
        return "localhost"
    }

    let hostname = String(cString: buffer)
    buffer.deallocate()

    return hostname
}
```

è¿™é‡Œæœ‰ä¸€ä¸ªåœ¨æœ€å¼€å§‹å°±åˆ›å»ºçš„ `UnsafeMutablePointer<UInt8>` ç”¨äºå­˜å‚¨ç›®æ ‡æ•°æ®ï¼Œä½†æ˜¯æˆ‘**æ—¢è¦**åœ¨é”™è¯¯å‘ç”Ÿåé”€æ¯å®ƒï¼Œ**åˆè¦**åœ¨æ­£å¸¸æµç¨‹ä¸‹ä¸å†ä½¿ç”¨å®ƒæ—¶å¯¹å…¶è¿›è¡Œé”€æ¯ã€‚

è¿™ç§è®¾è®¡å¾ˆå®¹æ˜“å¯¼è‡´é”™è¯¯ï¼Œè€Œä¸”ä¸åœåœ°åœ¨åšé‡å¤å·¥ä½œã€‚

é€šè¿‡ä½¿ç”¨ `defer` è¯­å¥ï¼Œæˆ‘ä»¬å¯ä»¥æ’é™¤æ½œåœ¨çš„é”™è¯¯å¹¶ä¸”ç®€åŒ–ä»£ç ï¼š

```swift
func currentHostName() -> String {
    let capacity = Int(NI_MAXHOST)
    let buffer = UnsafeMutablePointer<Int8>.allocate(capacity: capacity)
    
    defer { buffer.deallocate() }

    guard gethostname(buffer, capacity) == 0 else {
        return "localhost"
    }

    return String(cString: buffer)
}
```

å°½ç®¡ `defer` ç´§æ¥ç€å‡ºç°åœ¨ `allocate(capacity:)` è°ƒç”¨ä¹‹åï¼Œä½†å®ƒè¦ç­‰åˆ°å½“å‰åŒºåŸŸç»“æŸæ—¶æ‰ä¼šè¢«æ‰§è¡Œã€‚å¤šäºäº† `defer`ï¼Œ`buffer` æ‰èƒ½æ— è®ºåœ¨å“ªä¸ªç‚¹é€€å‡ºå‡½æ•°éƒ½å¯ä»¥è¢«é‡Šæ”¾ã€‚

è€ƒè™‘åœ¨ä»»ä½•éœ€è¦é…å¯¹è°ƒç”¨çš„ API ä¸Šéƒ½ä½¿ç”¨ `defer`ï¼Œæ¯”å¦‚ `allocate(capacity:)` / `deallocate()`ã€`wait()` / `signal()` å’Œ `open()` / `close()`ã€‚è¿™æ ·çš„è¯ï¼Œä½ å°±å¯ä»¥æ¶ˆé™¤ä¸€ç§ç¨‹åºå‘˜æ˜“çŠ¯çš„é”™è¯¯ã€‚

#### å¤šä¸ª `defer`

å¦‚æœåœ¨åŒä¸€ä¸ªä½œç”¨åŸŸå†…ä½¿ç”¨å¤šä¸ª `defer` è¯­å¥ï¼Œå®ƒä»¬ä¼šæ ¹æ®å‡ºç°é¡ºåºåè¿‡æ¥æ‰§è¡Œâ€”â€”åƒæ ˆä¸€æ ·ã€‚è¿™ä¸ªååºæ˜¯éå¸¸é‡è¦çš„ç»†èŠ‚ï¼Œä¿è¯äº†è¢«å»¶è¿Ÿçš„ä»£ç å—åˆ›å»ºæ—¶ä½œç”¨åŸŸå†…å­˜åœ¨çš„ä¸œè¥¿ï¼Œåœ¨ä»£ç å—æ‰§è¡ŒåŒæ ·å­˜åœ¨ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œæ‰§è¡Œè¿™æ®µä»£ç ä¼šå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š

```swift
func procrastinate() {
    defer { print("wash the dishes") }
    defer { print("take out the recycling") }
    defer { print("clean the refrigerator") }

    print("play videogames")
}
/*  è¾“å‡ºç»“æœï¼š
	play videogames
	clean the refrigerator
	take out the recycling
	wash the dishes
*/
```

é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œå¦‚æœä½ åƒè¿™æ ·åµŒå¥—Â `defer`Â è¯­å¥ï¼Œä¼šæ€ä¹ˆæ ·ï¼Ÿ

```swift
defer { defer { print("clean the gutter") } }
```

å“ˆå“ˆï¼Œå½“ç„¶ä½ å¯ä»¥äº²è‡ªè¯•ä¸€ä¸‹ã€‚

#### `defer` ä¸­çš„å˜é‡

å¦‚æœåœ¨ `defer` è¯­å¥ä¸­å¼•ç”¨äº†ä¸€ä¸ªå˜é‡ï¼Œæ‰§è¡Œæ—¶ä¼šç”¨åˆ°å˜é‡æœ€ç»ˆçš„å€¼ã€‚æ¢å¥è¯è¯´ï¼š`defer` ä»£ç å—ä¸ä¼šæ•è·å˜é‡å½“å‰çš„å€¼ã€‚

å¦‚æœä½ è¿è¡Œè¿™æ®µä»£ç ï¼Œä½ ä¼šå¾—åˆ°ä¸‹é¢çš„è¾“å‡ºï¼š

```swift
func flipFlop() {
    var position = "It's pronounced /É¡Éªf/"
    defer { print(position) }

    position = "It's pronounced /dÊ’Éªf/"
    defer { print(position) }
}
/*  è¾“å‡ºç»“æœï¼š
	It's pronounced /dÊ’Éªf/
	It's pronounced /dÊ’Éªf/
*/
```

#### `defer` è·³ä¸å‡ºä½œç”¨åŸŸ

éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒÂ `defer`Â ä»£ç å—æ— æ³•è·³å‡ºå®ƒæ‰€åœ¨çš„ä½œç”¨åŸŸã€‚å› æ­¤å¦‚ä½ å°è¯•è°ƒç”¨ä¸€ä¸ªä¼š throw çš„æ–¹æ³•ï¼ŒæŠ›å‡ºçš„é”™è¯¯å°±æ— æ³•ä¼ é€’åˆ°å…¶å‘¨å›´çš„ä¸Šä¸‹æ–‡ã€‚

```swift
func burnAfterReading(file url: URL) throws {
    defer { try FileManager.default.removeItem(at: url) }
    // ğŸ›‘ Errors not handled

    let string = try String(contentsOf: url)
}
```

ä½œä¸ºæ›¿ä»£ï¼Œä½ å¯ä»¥ä½¿ç”¨Â `try?`Â æ¥æ— è§†æ‰é”™è¯¯ï¼Œæˆ–è€…ç›´æ¥å°†è¯­å¥ç§»å‡ºÂ `defer`Â ä»£ç å—ï¼Œå°†å…¶æ”¾åˆ°å‡½æ•°çš„æœ€åï¼Œæ­£å¸¸çš„æ‰§è¡Œã€‚



#### `defer` å¹¶ä¸æ˜¯æ€»æ˜¯ä¼šæ‰§è¡Œ

çœ‹çœ‹ä¸‹é¢è¿™ä¸ªæ —å­ï¼š

```swift
func foo() {
  guard false else { return }
  defer {
    print("finally")
  }
}
```

æ˜¾ç„¶ï¼Œä¸Šé¢æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ° `defer` è¿™ä¸€å¥ï¼Œè¿™æ—¶å€™å°±ä¸ä¼šè¢«æ‰§è¡Œã€‚

è¿™ä¸ªæ•…äº‹å‘Šè¯‰æˆ‘ä»¬ï¼Œè‡³å°‘è¦æ‰§è¡Œåˆ° `defer` è¿™ä¸€è¡Œï¼Œå®ƒæ‰ä¿è¯åé¢ä¼šè§¦å‘ã€‚

#### `defer` çš„åå¤„

è™½ç„¶Â `defer`Â åƒä¸€ä¸ªè¯­æ³•ç³–ä¸€æ ·ï¼Œä½†ä¹Ÿè¦å°å¿ƒä½¿ç”¨é¿å…å½¢æˆå®¹æ˜“è¯¯è§£ã€éš¾ä»¥é˜…è¯»çš„ä»£ç ã€‚åœ¨æŸäº›æƒ…å†µä¸‹ä½ å¯èƒ½ä¼šå°è¯•ç”¨Â `defer`Â æ¥å¯¹æŸäº›å€¼è¿”å›ä¹‹å‰åšæœ€åä¸€æ­¥çš„å¤„ç†ï¼Œä¾‹å¦‚è¯´åœ¨åç½®è¿ç®—ç¬¦Â `++`Â çš„å®ç°ä¸­ï¼š

```swift
postfix func ++(inout x: Int) -> Int {
    let current = x
    x += 1
    return current
}
```

åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨Â `defer`Â æ¥è¿›è¡Œä¸€ä¸ªå¾ˆå¦ç±»çš„æ“ä½œã€‚å¦‚æœèƒ½åœ¨ defer ä¸­å¤„ç†çš„è¯ä¸ºä»€ä¹ˆè¦åˆ›å»ºä¸´æ—¶å˜é‡å‘¢ï¼Ÿ

```swift
postfix func ++(inout x: Int) -> Int {
    defer { x += 1 }
    return x
}
```

è¿™ç§å†™æ³•ç¡®å®èªæ˜ï¼Œä½†è¿™æ ·å´é¢ å€’äº†å‡½æ•°çš„é€»è¾‘é¡ºåºï¼Œæå¤§é™ä½äº†ä»£ç çš„å¯è¯»æ€§ã€‚åº”è¯¥ä¸¥æ ¼éµå¾ªÂ `defer`åœ¨æ•´ä¸ªç¨‹åºæœ€åè¿è¡Œä»¥é‡Šæ”¾å·²ç”³è¯·èµ„æºçš„åŸåˆ™ï¼Œå…¶ä»–ä»»ä½•ä½¿ç”¨æ–¹æ³•éƒ½å¯èƒ½è®©ä»£ç ä¹±æˆä¸€å›¢ã€‚

ä¸€è„¸æ‡µé€¼æ˜¯ä¸æ˜¯ï¼Ÿ



**å†™åœ¨æœ€åï¼š**



ã€Œèªæ˜çš„ç¨‹åºå‘˜æ˜ç™½è‡ªå·±çš„å±€é™æ€§ã€ï¼Œæˆ‘ä»¬å¿…é¡»æƒè¡¡æ¯ç§è¯­è¨€ç‰¹æ€§çš„å¥½å¤„å’Œå…¶æˆæœ¬ã€‚

ç±»ä¼¼äº `guard` çš„æ–°ç‰¹æ€§èƒ½è®©ä»£ç æµç¨‹ä¸Šæ›´çº¿æ€§ï¼Œå¯è¯»æ€§æ›´é«˜ï¼Œå°±åº”è¯¥å°½å¯èƒ½ä½¿ç”¨ã€‚

åŒæ · `defer` ä¹Ÿè§£å†³äº†é‡è¦çš„é—®é¢˜ï¼Œä½†æ˜¯ä¼šå¼ºè¿«æˆ‘ä»¬ä¸€å®šè¦æ‰¾åˆ°å®ƒå£°æ˜çš„åœ°æ–¹æ‰èƒ½è¿½è¸ªåˆ°å…¶é”€æ¯çš„æ–¹æ³•ï¼Œå› ä¸ºå£°æ˜æ–¹æ³•å¾ˆå®¹æ˜“è¢«æ»šåŠ¨å‡ºäº†è§†é‡ä¹‹å¤–ï¼Œæ‰€ä»¥åº”è¯¥å°½å¯èƒ½éµå¾ªå®ƒå‡ºç°çš„åˆè¡·å°½å¯èƒ½å°‘åœ°ä½¿ç”¨ï¼Œé¿å…é€ æˆæ··æ·†å’Œæ™¦æ¶©ã€‚